{"title":"Reproducing a Grattan Institute map","markdown":{"yaml":{"title":"Reproducing a Grattan Institute map","description":"Blogdown is a package that allows you to make websites (not just blogs, notwithstanding its name) largely within R Studio. It builds on Hugo, which is a popular tool for making websites.\n","author":[{"name":"Rohan Alexander"}],"date":"2017-08-11","output":{"distill::distill_article":{"self_contained":false}}},"headingText":"Introduction","containsRefs":false,"markdown":"\n\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n\nlibrary(knitr)\n```\n\n\n*Thank you to Monica for her helpful edits.*\n\n*Geoffrey Liu found an error in how I deal with the postcodes data that I haven't fixed yet.*\n\nThe Grattan Institute is an Australian think tank that produces reports about public policy. Last week they released ['Regional patterns of Australia's economy and population'](https://grattan.edu.au/report/regional-patterns-of-australias-economy-and-population/). That report looks into the differences between geographic areas across various economic and demographic variables. It includes interactive maps made using Carto. The Grattan Institute also released the datasets that underpin the report's maps and graphs.\n\nI was interested to see if I could reproduce one of their interactive maps - [Annual income growth per person (FY04 - FY15)](https://grattan.carto.com/me) - in an hour using R and the Leaflet package. A day later I found the underlying dataset did not correspond with the map that the Grattan Institute published. But following the methodology in the report I was able to create a dataset that seems pretty close to the values illustrated on their map.\n\nThe final map that I produced is below (it'll take about 5 seconds to load) and this note records what I did to produce it in R using the Leaflet package.\n\n```{r, echo=FALSE}\nknitr::include_app(\"https://rohanalexander.shinyapps.io/grattan/\", \n  height = \"600px\")\n```\n\n\n\n# Workspace\nThe first step was to set-up the workspace. Mostly this just meant loading packages. The <tt>tidyverse</tt> and <tt>magrittr</tt> packages help with general data manipulation tasks; <tt>zoo</tt> helps with the rolling average needed later; and <tt>leaflet</tt>, <tt>rgdal</tt>, and <tt>rmapshaper</tt> are specific to mapping.\n\n```{r, eval=FALSE, echo=TRUE}\nlibrary(tidyverse)\nlibrary(magrittr)\nlibrary(zoo)\nlibrary(leaflet)\nlibrary(rgdal)\nlibrary(rmapshaper)\n```\n\n\n# Data\nI decided to reproduce Figure 2.4 of the report. This shows the average annual growth in real taxable income per tax filer between the financial years 2003/04 and 2014/15 for the 2011 SA3 areas. To do this I needed the incomes data that the Grattan Institute mapped and the geographic data that defines the areas.\n\n## Incomes\nThe Grattan Institute released the datasets that they said had been mapped. It was straightforward to download this file and export the relevant sheet as a csv file. The Excel file is available at https://grattan.edu.au/report/regional-patterns-of-australias-economy-and-population/ (in the left panel).\n\n```{r, eval=FALSE, echo=TRUE}\n# Import the income data that has been taken from the Grattan data download, sheet 'Figure 2.4' (which was saved as a csv).\nincomes <- read_csv(\"data/890-Regional-patterns-chart-data.csv\")\n# Remove some debris columns\nincomes <- incomes %>%\n  select(\"SA3\", \"Growth_mean_income_FY04_FY15\")\n```\n\n## Geographies\nThe other dataset that I needed was the geographies that the Grattan Institute had used. I initially wasted a lot of time using the 2016 SA3 release. Eventually I realised they were using the SA3 release from 2011. This is available from the ABS website at: http://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1270.0.55.001July%202011?OpenDocument and I used the zipped file: 'Statistical Area Level 3 (SA3) ASGS Ed 2011 Digital Boundaries in ESRI Shapefile Format'.\n\n```{r, eval=FALSE, echo=TRUE}\n# 2011 SA3 boundaries\nold_boundaries <- readOGR(dsn = \"data/1270055001_sa3_2011_aust_shape\", layer = \"SA3_2011_AUST\")\n# Add the income data into the boundaries dataset\nold_boundaries <- merge(old_boundaries, incomes, by.x = \"SA3_NAME11\", by.y = \"SA3\")\n```\n\nComparing the incomes data with the 2011 geographies data indicates the incomes data is missing two SA3 areas: 'Illawarra Catchment Reserve' and 'Blue Mountains - South'. I also found these areas had been left as NA in the Grattan Institute's interactive map. This made me confident that the Grattan Institute was using the 2011 boundaries (I may have missed it but I don't think this was documented).\n\n\n# Map\nMaking the map was not complicated once the pieces were in place. I called Leaflet and specified a black and white base map. After that I adjusted the default view and then added the patchwork quilt that shows the incomes dataset by SA3 area. \n\nI didn't spend too much time on the colours because the inferno palette got fairly close. I just copied their published bins to reproduce the breaks that the Grattan Institute used. Box 1 in Appendix A of the Grattan Institute's report specifies how they came up with these bins. Give my purposes I didn't worry too much about this.\n\n```{r, eval=FALSE, echo=TRUE}\n# Set the color scheme \npal <- colorBin(\n  palette = \"inferno\",\n  domain = old_boundaries$Growth_mean_income_FY04_FY15,\n  bins = c(0, 0.005, 0.012, 0.015, 0.017, 0.019, 0.022, 0.029, 0.07),\n  reverse = TRUE\n  )\n\n# Make the map\nAustralia_incomes_map <- \n  leaflet() %>%\n  # Base map\n  addProviderTiles(providers$Stamen.TonerLite, group = \"Toner Lite\") %>% \n  setView(lng = 133.7751, lat = -25.2744, zoom = 4) %>% # Specify where the map is initially focused\n  addPolygons(data = old_boundaries, \n              color = pal(old_boundaries$Growth_mean_income_FY04_FY15), \n              weight = 1, \n              stroke = FALSE,\n              smoothFactor = 0.5,\n              fillOpacity = 0.8, \n              label = paste(\"Area name (SA3):\", as.character(old_boundaries$SA3_NAME11), \n                            \"Mean annual growth:\", as.character(old_boundaries$Growth_mean_income_FY04_FY15)),\n              highlightOptions = highlightOptions(color = \"#666\", weight = 2, bringToFront = FALSE)) %>% \n  addLegend(\"bottomright\", pal = pal, values = old_boundaries$Growth_mean_income_FY04_FY15,\n            title = \"Mean annual income growth (FY04 - FY15)\",\n            opacity = 0.4\n  )\n\n# Call the map\nAustralia_incomes_map\n```\n\nThere were many small changes that could be made to better reproduce the Grattan Institute's map, but at this stage I realised there was something going on with the data. I decided to spend more time with that than tweaking the remaining aspects.\n\n# Comparison \n## Issues\nComparing screenshots of the maps shows some of the issues:\n\n```{r fig.cap=\"Grattan's map\", echo=FALSE}\nknitr::include_graphics(\"images/grattan.png\")\n```\n\n```{r fig.cap=\"My map\", echo=FALSE}\nknitr::include_graphics(\"images/me.png\")\n```\n\nFor instance there are areas where my map has a lot more variation such as:\n\n* the northern SA3 areas of Queensland; and\n* the SA3 areas in the south west of Western Australia.\n\nAnd there are also some areas where the colours are fairly different (notwithstanding the fact that I didn't match theirs exactly), such as:\n\n* west of Melbourne where my values are a lot higher.\n\n## Triage\nI checked that I was using the dataset that I had meant to use. While I was checking this dataset (which is the one that the Grattan Institute makes available) I noticed that the numbers in the Grattan Institute's dataset were not always the ones that were being mapped. This was easy to see because they included a static version of the map next to the dataset, so I was confident it was meant to be the same. \n\nI couldn't work out how to download the actual dataset underlying the interactive Carto map. But I was able to check some on an area-by-area basis because the value was displayed on mouse-hover. I found that the figure that was displayed did line up with the colour of the area, but not the dataset that they offered as underpinning the map.\n\nThe following table summarises some of the SA3 areas in north Queensland. \n\nSA3 Area  | Grattan Carto value | Grattan data value\n------------- | ------------- | -------------\nCairns - South  | 1.73 | 2.0\nCharters Towers - Ayr - Ingham  | 2.35 | 1.6\nFar North   | 2.66 | 3.0\nOutback - North  | 2.33 | 1.7\nPort Douglas - Daintree  | 1.73 | 1.4\nTablelands (East) - Kuranda  | 2.23 | 1.6\n\nThe key issue was whether it was the Carto map or the dataset that was wrong.\n\n# Down the rabbit hole\nBy this stage it was after dinner, and I'd had a glass or three of wine. But the only way to work out whether it was the dataset or the map that was wrong was to recreate the dataset myself. To do this I needed: \n\n* incomes data for financial years 2003-04 and 2014-15;\n* an inflation rate over this time to make the 2003-04 data real; and\n* a correspondence from postcodes to the 2011 SA3 areas.\n\nWithout their code it would be hard to be certain, but the Grattan Institute provided enough information in the report that I was confident I could get reasonably close to what they'd done.\n\n## Incomes\nThe incomes data is from Table 8 of the ATO's 2015 tax stats which is available here:\nhttps://data.gov.au/dataset/taxation-statistics-2014-15/resource/02e58971-ddee-4f77-af15-5c45de569ed6\n\n```{r, eval=FALSE, echo=TRUE}\n# Import the tax data\ntax_data <- read_csv(\"data/taxstats2015individual08medianaveragetaxableincomestateterritorypostcode.csv\", skip = 2, col_names = FALSE)\n# Remove the debris rows\ntax_data <- tax_data[2:2254,]\n# Grattan says we only need postcode, the 2003/04 data and the 2014/15 data, so drop the rest of the variables\ntax_data <- tax_data %>%\n  select(X2:X5, X11:X13)\n# Fix the column names\ntax_data <- rename(tax_data, \"postcode\" = X2, \"population_0304\" = X3, \"median_inc_0304\" = X4, \"ave_inc_0304\" = X5, \"population_1415\" = X11, \"median_inc_1415\" = X12, \"ave_inc_1415\" = X13)\n# Finally, change the classes to numeric (need to remove the comma first)\ntax_data$population_0304 <- sub(\",\", \"\", tax_data$population_0304)\ntax_data$median_inc_0304 <- sub(\",\", \"\", tax_data$median_inc_0304)\ntax_data$ave_inc_0304 <- sub(\",\", \"\", tax_data$ave_inc_0304)\ntax_data$population_1415 <- sub(\",\", \"\", tax_data$population_1415)\ntax_data$median_inc_1415 <- sub(\",\", \"\", tax_data$median_inc_1415)\ntax_data$ave_inc_1415 <- sub(\",\", \"\", tax_data$ave_inc_1415)\ntax_data$postcode <- as.numeric(tax_data$postcode)\ntax_data$population_0304 <- as.numeric(tax_data$population_0304)\ntax_data$median_inc_0304 <- as.numeric(tax_data$median_inc_0304)\ntax_data$ave_inc_0304 <- as.numeric(tax_data$ave_inc_0304)\ntax_data$population_1415 <- as.numeric(tax_data$population_1415)\ntax_data$median_inc_1415 <- as.numeric(tax_data$median_inc_1415)\ntax_data$ave_inc_1415 <- as.numeric(tax_data$ave_inc_1415)\n```\n\n## Inflation\nI needed to change the financial year 2003-04 incomes into 2014-15 dollars. In the Grattan Institute's report (p. 34) they say:\n\n> Nominal income for the 2003-04 financial year was adjusted to real\n2014-15 dollars, using a yearly average of ABS quarterly data on the\nConsumer Price Index, starting from the 2003 September quarter.\n\nI downloaded the inflation data that they specified from:\nhttp://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/6401.0Mar%202017?OpenDocument\n(it is Series A2325846C which is in Tables 1 and 2 of the release). I wasn't exactly sure how the Grattan Institute constructed its measure, but I decided to just go with the RBA formula (http://www.rba.gov.au/calculator/) which is: (Average of the four quarters in the final year / average of the four quarters in the first year - 1) *100, although I didn't need to worry about removing one or the multiplying. \n\n```{r, eval=FALSE, echo=TRUE}\n# Import the inflation data\ninflation_data <- read_csv(\"data/640101.csv\", skip = 10, col_names = FALSE)\n# Grab the series they use: A2325846C\ninflation_data <- inflation_data %>%\n  select(X1, X10)\n# Fix the column names\ninflation_data <- rename(inflation_data, \n                   \"quarter\" = X1,\n                   \"index_value\" = X10\n)\n# To use the RBA formula we need the average index number over the four quarters\ninflation_data <- inflation_data %>%\n  mutate(\n    average_index_over_year = rollmean(index_value, 4, align = 'right', fill = NA)\n  )\n# Now we just use (final_year_ave / first_year_ave) (don't need to bother with removing the 1 or multiplying by 100 because we are just going to multiply the first year data up to get in terms of final year)\ninflation_rate <- \n  ((inflation_data$average_index_over_year[inflation_data$quarter == \"Jun-2015\"] / inflation_data$average_index_over_year[inflation_data$quarter == \"Jun-2004\"]))\n```\n\nThe inflation adjustment turned out to be about 1.34. I also worked out the annual inflation rates and then chained them, and also tried just using the start and end quarter index numbers (not averaged). They came to similar values, so even though I wasn't exactly sure what the Grattan Institute had done, I was confident that small differences wouldn't matter too much.\n\n## Growth\nI then needed to create the annual growth rate that the Grattan Institute used (p. 34):\n\n> Growth in taxable income is calculated as a compound annual growth\nrate from the 2003-04 financial year to the 2014-15 financial year.\n\n```{r, eval=FALSE, echo=TRUE}\n## Data manipulation - create the new interest variable that is of interest - 11 years?\ntax_data <- tax_data %>%\n  mutate(\n    real_ave_inc_0304 = ave_inc_0304 * inflation_rate,\n    real_median_inc_0304 = median_inc_0304 * inflation_rate,\n    annual_ave_growth = (ave_inc_1415/real_ave_inc_0304)^(1/11),\n    annual_median_growth = (median_inc_1415/real_median_inc_0304)^(1/11)\n  )\n```\n\n\n## Correspondence\nThe incomes data that the ATO makes available is on a postcode basis. I needed to convert this into 2011 SA3 levels and the ABS makes a correspondence for this purpose. This is available at: http://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1270.0.55.006July%202011?OpenDocument where the correct table is the zipped file 'Postcode 2011 to Statistical Area Level 3 2011'.\n\n```{r, eval=FALSE, echo=TRUE}\n# Import the correspondence\ncorrespondence <- read_csv(\"data/1270055006_CG_POSTCODE_2011_SA3_2011.csv\", skip = 7, col_names = FALSE)\ncorrespondence <- correspondence %>%\n  select(X2:X6)\n# Fix the column names\ncorrespondence <- rename(correspondence, \n                   \"postcode\" = X2,\n                   \"SA3_CODE_2011\" = X3,\n                   \"SA3_NAME_2011\" = X4,\n                   \"ratio\" = X5,\n                   \"percentage\" = X6\n)\n\ncorrespondence <- merge(correspondence, tax_data, by.x = \"postcode\", by.y = \"postcode\")\nmatch\n\ncorrespondence <- correspondence %>%\n  mutate(\n    contribution_ave = ratio * annual_ave_growth,\n    contribution_median = ratio * annual_median_growth\n  )\n\nsa3_data <- correspondence %>%\n  group_by(SA3_NAME_2011) %>%\n  summarise(\n    ave_growth = weighted.mean(annual_ave_growth, ratio, na.rm = T),\n    median_growth = weighted.mean(annual_median_growth, ratio, na.rm = T)\n  )\n```\n\n## Putting it all together\nThis result of all this is that I created a dataset that seems pretty much the same as the one that the Grattan Institute mapped, but not the one that they released.\n\n```{r, eval=TRUE, echo=TRUE}\n#load(\"sa3_data.Rda\")\n#head(sa3_data, n = 20)\n```\n\nMy dataset can be downloaded as a csv here: https://github.com/RohanAlexander/blogdown_website/blob/master/content/post/sa3_data.csv\n\nThe values underlying the Grattan Carto map and the values that I generated are the same for the five 2011 SA3 areas in the earlier table:\n\nSA3 Area  | Grattan Carto value | Grattan data value | My value\n------------- | ------------- | ------------- | -------------\nCairns - South  | 1.73 | 2.0 | 1.73\nCharters Towers - Ayr - Ingham  | 2.35 | 1.6 | 2.35\nFar North   | 2.66 | 3.0 | 2.66\nOutback - North  | 2.33 | 1.7 | 2.33\nPort Douglas - Daintree  | 1.73 | 1.4 | 1.73\nTablelands (East) - Kuranda  | 2.23 | 1.6 | 2.23\n\nAfter having compared my values with theirs I think that in their Excel dataset the Grattan Institute ordered the columns for the SA3 areas and the incomes data separately instead of together.\n\n## Reconciliation\nI've reached out to the Grattan Institute and will update this post based on what they say.\n\n\n\n# Conclusion\nThe Grattan Institute is probably Australia's most important think tank in terms of not being overly associated with one side of politics but still making a contribution to thinking on policy. It is good that they are being more open about their datasets, but it would be much better if they made their code available. Using tools like Leaflet and ggmap instead of Carto would help with this.\n\nIt was fun to spend the day in the data-analyst's version of a treasure chase. But hopefully the next time I decide to reproduce a Grattan Institute map common sense prevails before I go too far down the rabbit hole.\n\n![I regret nothing :)](https://imgs.xkcd.com/comics/duty_calls.png)\n\n\n*Disclosures: In the interest of transparency I'll point out that I applied unsuccessfully for a job at the Grattan Institute about five years ago. One friend works as a research assistant for them on a casual basis; and there are a few friends-of-friends who work there full time, but I haven't talked about this post with any of them.*\n","srcMarkdownNoYaml":"\n\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n\nlibrary(knitr)\n```\n\n\n*Thank you to Monica for her helpful edits.*\n\n*Geoffrey Liu found an error in how I deal with the postcodes data that I haven't fixed yet.*\n\n# Introduction\nThe Grattan Institute is an Australian think tank that produces reports about public policy. Last week they released ['Regional patterns of Australia's economy and population'](https://grattan.edu.au/report/regional-patterns-of-australias-economy-and-population/). That report looks into the differences between geographic areas across various economic and demographic variables. It includes interactive maps made using Carto. The Grattan Institute also released the datasets that underpin the report's maps and graphs.\n\nI was interested to see if I could reproduce one of their interactive maps - [Annual income growth per person (FY04 - FY15)](https://grattan.carto.com/me) - in an hour using R and the Leaflet package. A day later I found the underlying dataset did not correspond with the map that the Grattan Institute published. But following the methodology in the report I was able to create a dataset that seems pretty close to the values illustrated on their map.\n\nThe final map that I produced is below (it'll take about 5 seconds to load) and this note records what I did to produce it in R using the Leaflet package.\n\n```{r, echo=FALSE}\nknitr::include_app(\"https://rohanalexander.shinyapps.io/grattan/\", \n  height = \"600px\")\n```\n\n\n\n# Workspace\nThe first step was to set-up the workspace. Mostly this just meant loading packages. The <tt>tidyverse</tt> and <tt>magrittr</tt> packages help with general data manipulation tasks; <tt>zoo</tt> helps with the rolling average needed later; and <tt>leaflet</tt>, <tt>rgdal</tt>, and <tt>rmapshaper</tt> are specific to mapping.\n\n```{r, eval=FALSE, echo=TRUE}\nlibrary(tidyverse)\nlibrary(magrittr)\nlibrary(zoo)\nlibrary(leaflet)\nlibrary(rgdal)\nlibrary(rmapshaper)\n```\n\n\n# Data\nI decided to reproduce Figure 2.4 of the report. This shows the average annual growth in real taxable income per tax filer between the financial years 2003/04 and 2014/15 for the 2011 SA3 areas. To do this I needed the incomes data that the Grattan Institute mapped and the geographic data that defines the areas.\n\n## Incomes\nThe Grattan Institute released the datasets that they said had been mapped. It was straightforward to download this file and export the relevant sheet as a csv file. The Excel file is available at https://grattan.edu.au/report/regional-patterns-of-australias-economy-and-population/ (in the left panel).\n\n```{r, eval=FALSE, echo=TRUE}\n# Import the income data that has been taken from the Grattan data download, sheet 'Figure 2.4' (which was saved as a csv).\nincomes <- read_csv(\"data/890-Regional-patterns-chart-data.csv\")\n# Remove some debris columns\nincomes <- incomes %>%\n  select(\"SA3\", \"Growth_mean_income_FY04_FY15\")\n```\n\n## Geographies\nThe other dataset that I needed was the geographies that the Grattan Institute had used. I initially wasted a lot of time using the 2016 SA3 release. Eventually I realised they were using the SA3 release from 2011. This is available from the ABS website at: http://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1270.0.55.001July%202011?OpenDocument and I used the zipped file: 'Statistical Area Level 3 (SA3) ASGS Ed 2011 Digital Boundaries in ESRI Shapefile Format'.\n\n```{r, eval=FALSE, echo=TRUE}\n# 2011 SA3 boundaries\nold_boundaries <- readOGR(dsn = \"data/1270055001_sa3_2011_aust_shape\", layer = \"SA3_2011_AUST\")\n# Add the income data into the boundaries dataset\nold_boundaries <- merge(old_boundaries, incomes, by.x = \"SA3_NAME11\", by.y = \"SA3\")\n```\n\nComparing the incomes data with the 2011 geographies data indicates the incomes data is missing two SA3 areas: 'Illawarra Catchment Reserve' and 'Blue Mountains - South'. I also found these areas had been left as NA in the Grattan Institute's interactive map. This made me confident that the Grattan Institute was using the 2011 boundaries (I may have missed it but I don't think this was documented).\n\n\n# Map\nMaking the map was not complicated once the pieces were in place. I called Leaflet and specified a black and white base map. After that I adjusted the default view and then added the patchwork quilt that shows the incomes dataset by SA3 area. \n\nI didn't spend too much time on the colours because the inferno palette got fairly close. I just copied their published bins to reproduce the breaks that the Grattan Institute used. Box 1 in Appendix A of the Grattan Institute's report specifies how they came up with these bins. Give my purposes I didn't worry too much about this.\n\n```{r, eval=FALSE, echo=TRUE}\n# Set the color scheme \npal <- colorBin(\n  palette = \"inferno\",\n  domain = old_boundaries$Growth_mean_income_FY04_FY15,\n  bins = c(0, 0.005, 0.012, 0.015, 0.017, 0.019, 0.022, 0.029, 0.07),\n  reverse = TRUE\n  )\n\n# Make the map\nAustralia_incomes_map <- \n  leaflet() %>%\n  # Base map\n  addProviderTiles(providers$Stamen.TonerLite, group = \"Toner Lite\") %>% \n  setView(lng = 133.7751, lat = -25.2744, zoom = 4) %>% # Specify where the map is initially focused\n  addPolygons(data = old_boundaries, \n              color = pal(old_boundaries$Growth_mean_income_FY04_FY15), \n              weight = 1, \n              stroke = FALSE,\n              smoothFactor = 0.5,\n              fillOpacity = 0.8, \n              label = paste(\"Area name (SA3):\", as.character(old_boundaries$SA3_NAME11), \n                            \"Mean annual growth:\", as.character(old_boundaries$Growth_mean_income_FY04_FY15)),\n              highlightOptions = highlightOptions(color = \"#666\", weight = 2, bringToFront = FALSE)) %>% \n  addLegend(\"bottomright\", pal = pal, values = old_boundaries$Growth_mean_income_FY04_FY15,\n            title = \"Mean annual income growth (FY04 - FY15)\",\n            opacity = 0.4\n  )\n\n# Call the map\nAustralia_incomes_map\n```\n\nThere were many small changes that could be made to better reproduce the Grattan Institute's map, but at this stage I realised there was something going on with the data. I decided to spend more time with that than tweaking the remaining aspects.\n\n# Comparison \n## Issues\nComparing screenshots of the maps shows some of the issues:\n\n```{r fig.cap=\"Grattan's map\", echo=FALSE}\nknitr::include_graphics(\"images/grattan.png\")\n```\n\n```{r fig.cap=\"My map\", echo=FALSE}\nknitr::include_graphics(\"images/me.png\")\n```\n\nFor instance there are areas where my map has a lot more variation such as:\n\n* the northern SA3 areas of Queensland; and\n* the SA3 areas in the south west of Western Australia.\n\nAnd there are also some areas where the colours are fairly different (notwithstanding the fact that I didn't match theirs exactly), such as:\n\n* west of Melbourne where my values are a lot higher.\n\n## Triage\nI checked that I was using the dataset that I had meant to use. While I was checking this dataset (which is the one that the Grattan Institute makes available) I noticed that the numbers in the Grattan Institute's dataset were not always the ones that were being mapped. This was easy to see because they included a static version of the map next to the dataset, so I was confident it was meant to be the same. \n\nI couldn't work out how to download the actual dataset underlying the interactive Carto map. But I was able to check some on an area-by-area basis because the value was displayed on mouse-hover. I found that the figure that was displayed did line up with the colour of the area, but not the dataset that they offered as underpinning the map.\n\nThe following table summarises some of the SA3 areas in north Queensland. \n\nSA3 Area  | Grattan Carto value | Grattan data value\n------------- | ------------- | -------------\nCairns - South  | 1.73 | 2.0\nCharters Towers - Ayr - Ingham  | 2.35 | 1.6\nFar North   | 2.66 | 3.0\nOutback - North  | 2.33 | 1.7\nPort Douglas - Daintree  | 1.73 | 1.4\nTablelands (East) - Kuranda  | 2.23 | 1.6\n\nThe key issue was whether it was the Carto map or the dataset that was wrong.\n\n# Down the rabbit hole\nBy this stage it was after dinner, and I'd had a glass or three of wine. But the only way to work out whether it was the dataset or the map that was wrong was to recreate the dataset myself. To do this I needed: \n\n* incomes data for financial years 2003-04 and 2014-15;\n* an inflation rate over this time to make the 2003-04 data real; and\n* a correspondence from postcodes to the 2011 SA3 areas.\n\nWithout their code it would be hard to be certain, but the Grattan Institute provided enough information in the report that I was confident I could get reasonably close to what they'd done.\n\n## Incomes\nThe incomes data is from Table 8 of the ATO's 2015 tax stats which is available here:\nhttps://data.gov.au/dataset/taxation-statistics-2014-15/resource/02e58971-ddee-4f77-af15-5c45de569ed6\n\n```{r, eval=FALSE, echo=TRUE}\n# Import the tax data\ntax_data <- read_csv(\"data/taxstats2015individual08medianaveragetaxableincomestateterritorypostcode.csv\", skip = 2, col_names = FALSE)\n# Remove the debris rows\ntax_data <- tax_data[2:2254,]\n# Grattan says we only need postcode, the 2003/04 data and the 2014/15 data, so drop the rest of the variables\ntax_data <- tax_data %>%\n  select(X2:X5, X11:X13)\n# Fix the column names\ntax_data <- rename(tax_data, \"postcode\" = X2, \"population_0304\" = X3, \"median_inc_0304\" = X4, \"ave_inc_0304\" = X5, \"population_1415\" = X11, \"median_inc_1415\" = X12, \"ave_inc_1415\" = X13)\n# Finally, change the classes to numeric (need to remove the comma first)\ntax_data$population_0304 <- sub(\",\", \"\", tax_data$population_0304)\ntax_data$median_inc_0304 <- sub(\",\", \"\", tax_data$median_inc_0304)\ntax_data$ave_inc_0304 <- sub(\",\", \"\", tax_data$ave_inc_0304)\ntax_data$population_1415 <- sub(\",\", \"\", tax_data$population_1415)\ntax_data$median_inc_1415 <- sub(\",\", \"\", tax_data$median_inc_1415)\ntax_data$ave_inc_1415 <- sub(\",\", \"\", tax_data$ave_inc_1415)\ntax_data$postcode <- as.numeric(tax_data$postcode)\ntax_data$population_0304 <- as.numeric(tax_data$population_0304)\ntax_data$median_inc_0304 <- as.numeric(tax_data$median_inc_0304)\ntax_data$ave_inc_0304 <- as.numeric(tax_data$ave_inc_0304)\ntax_data$population_1415 <- as.numeric(tax_data$population_1415)\ntax_data$median_inc_1415 <- as.numeric(tax_data$median_inc_1415)\ntax_data$ave_inc_1415 <- as.numeric(tax_data$ave_inc_1415)\n```\n\n## Inflation\nI needed to change the financial year 2003-04 incomes into 2014-15 dollars. In the Grattan Institute's report (p. 34) they say:\n\n> Nominal income for the 2003-04 financial year was adjusted to real\n2014-15 dollars, using a yearly average of ABS quarterly data on the\nConsumer Price Index, starting from the 2003 September quarter.\n\nI downloaded the inflation data that they specified from:\nhttp://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/6401.0Mar%202017?OpenDocument\n(it is Series A2325846C which is in Tables 1 and 2 of the release). I wasn't exactly sure how the Grattan Institute constructed its measure, but I decided to just go with the RBA formula (http://www.rba.gov.au/calculator/) which is: (Average of the four quarters in the final year / average of the four quarters in the first year - 1) *100, although I didn't need to worry about removing one or the multiplying. \n\n```{r, eval=FALSE, echo=TRUE}\n# Import the inflation data\ninflation_data <- read_csv(\"data/640101.csv\", skip = 10, col_names = FALSE)\n# Grab the series they use: A2325846C\ninflation_data <- inflation_data %>%\n  select(X1, X10)\n# Fix the column names\ninflation_data <- rename(inflation_data, \n                   \"quarter\" = X1,\n                   \"index_value\" = X10\n)\n# To use the RBA formula we need the average index number over the four quarters\ninflation_data <- inflation_data %>%\n  mutate(\n    average_index_over_year = rollmean(index_value, 4, align = 'right', fill = NA)\n  )\n# Now we just use (final_year_ave / first_year_ave) (don't need to bother with removing the 1 or multiplying by 100 because we are just going to multiply the first year data up to get in terms of final year)\ninflation_rate <- \n  ((inflation_data$average_index_over_year[inflation_data$quarter == \"Jun-2015\"] / inflation_data$average_index_over_year[inflation_data$quarter == \"Jun-2004\"]))\n```\n\nThe inflation adjustment turned out to be about 1.34. I also worked out the annual inflation rates and then chained them, and also tried just using the start and end quarter index numbers (not averaged). They came to similar values, so even though I wasn't exactly sure what the Grattan Institute had done, I was confident that small differences wouldn't matter too much.\n\n## Growth\nI then needed to create the annual growth rate that the Grattan Institute used (p. 34):\n\n> Growth in taxable income is calculated as a compound annual growth\nrate from the 2003-04 financial year to the 2014-15 financial year.\n\n```{r, eval=FALSE, echo=TRUE}\n## Data manipulation - create the new interest variable that is of interest - 11 years?\ntax_data <- tax_data %>%\n  mutate(\n    real_ave_inc_0304 = ave_inc_0304 * inflation_rate,\n    real_median_inc_0304 = median_inc_0304 * inflation_rate,\n    annual_ave_growth = (ave_inc_1415/real_ave_inc_0304)^(1/11),\n    annual_median_growth = (median_inc_1415/real_median_inc_0304)^(1/11)\n  )\n```\n\n\n## Correspondence\nThe incomes data that the ATO makes available is on a postcode basis. I needed to convert this into 2011 SA3 levels and the ABS makes a correspondence for this purpose. This is available at: http://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1270.0.55.006July%202011?OpenDocument where the correct table is the zipped file 'Postcode 2011 to Statistical Area Level 3 2011'.\n\n```{r, eval=FALSE, echo=TRUE}\n# Import the correspondence\ncorrespondence <- read_csv(\"data/1270055006_CG_POSTCODE_2011_SA3_2011.csv\", skip = 7, col_names = FALSE)\ncorrespondence <- correspondence %>%\n  select(X2:X6)\n# Fix the column names\ncorrespondence <- rename(correspondence, \n                   \"postcode\" = X2,\n                   \"SA3_CODE_2011\" = X3,\n                   \"SA3_NAME_2011\" = X4,\n                   \"ratio\" = X5,\n                   \"percentage\" = X6\n)\n\ncorrespondence <- merge(correspondence, tax_data, by.x = \"postcode\", by.y = \"postcode\")\nmatch\n\ncorrespondence <- correspondence %>%\n  mutate(\n    contribution_ave = ratio * annual_ave_growth,\n    contribution_median = ratio * annual_median_growth\n  )\n\nsa3_data <- correspondence %>%\n  group_by(SA3_NAME_2011) %>%\n  summarise(\n    ave_growth = weighted.mean(annual_ave_growth, ratio, na.rm = T),\n    median_growth = weighted.mean(annual_median_growth, ratio, na.rm = T)\n  )\n```\n\n## Putting it all together\nThis result of all this is that I created a dataset that seems pretty much the same as the one that the Grattan Institute mapped, but not the one that they released.\n\n```{r, eval=TRUE, echo=TRUE}\n#load(\"sa3_data.Rda\")\n#head(sa3_data, n = 20)\n```\n\nMy dataset can be downloaded as a csv here: https://github.com/RohanAlexander/blogdown_website/blob/master/content/post/sa3_data.csv\n\nThe values underlying the Grattan Carto map and the values that I generated are the same for the five 2011 SA3 areas in the earlier table:\n\nSA3 Area  | Grattan Carto value | Grattan data value | My value\n------------- | ------------- | ------------- | -------------\nCairns - South  | 1.73 | 2.0 | 1.73\nCharters Towers - Ayr - Ingham  | 2.35 | 1.6 | 2.35\nFar North   | 2.66 | 3.0 | 2.66\nOutback - North  | 2.33 | 1.7 | 2.33\nPort Douglas - Daintree  | 1.73 | 1.4 | 1.73\nTablelands (East) - Kuranda  | 2.23 | 1.6 | 2.23\n\nAfter having compared my values with theirs I think that in their Excel dataset the Grattan Institute ordered the columns for the SA3 areas and the incomes data separately instead of together.\n\n## Reconciliation\nI've reached out to the Grattan Institute and will update this post based on what they say.\n\n\n\n# Conclusion\nThe Grattan Institute is probably Australia's most important think tank in terms of not being overly associated with one side of politics but still making a contribution to thinking on policy. It is good that they are being more open about their datasets, but it would be much better if they made their code available. Using tools like Leaflet and ggmap instead of Carto would help with this.\n\nIt was fun to spend the day in the data-analyst's version of a treasure chase. But hopefully the next time I decide to reproduce a Grattan Institute map common sense prevails before I go too far down the rabbit hole.\n\n![I regret nothing :)](https://imgs.xkcd.com/comics/duty_calls.png)\n\n\n*Disclosures: In the interest of transparency I'll point out that I applied unsuccessfully for a job at the Grattan Institute about five years ago. One friend works as a research assistant for them on a casual basis; and there are a few friends-of-friends who work there full time, but I haven't talked about this post with any of them.*\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":{"distill::distill_article":{"self_contained":false}},"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"reproducing-a-grattan-map.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Danger","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.266","theme":"cosmo","title":"Reproducing a Grattan Institute map","description":"Blogdown is a package that allows you to make websites (not just blogs, notwithstanding its name) largely within R Studio. It builds on Hugo, which is a popular tool for making websites.\n","author":[{"name":"Rohan Alexander"}],"date":"2017-08-11"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}